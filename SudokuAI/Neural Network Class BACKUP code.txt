import cv2
import numpy as np
from PIL import Image
import pytesseract
pytesseract.pytesseract.tesseract_cmd = r"C:\Program Files\Tesseract-OCR\tesseract.exe"

class SudokuImageParser:
    def extract_sudoku_grid(image_path):
        """
        Convert a Sudoku image into a 9x9 digital list.
        Empty cells are represented as 0.
        """
        # Read the image
        img = cv2.imread(image_path)
        gray = cv2.cvtColor(img, cv2.COLOR_BGR2GRAY)
        
        # Apply threshold to get better contrast
        _, thresh = cv2.threshold(gray, 128, 255, cv2.THRESH_BINARY_INV)
        
        # Find contours to detect the grid
        contours, _ = cv2.findContours(thresh, cv2.RETR_EXTERNAL, cv2.CHAIN_APPROX_SIMPLE)
        
        # Find the largest contour (should be the grid)
        largest_contour = max(contours, key=cv2.contourArea)
        x, y, w, h = cv2.boundingRect(largest_contour)
        
        # Extract the grid region
        grid_img = gray[y:y+h, x:x+w]
        
        # Initialize the 9x9 grid
        sudoku_grid = [[0 for _ in range(9)] for _ in range(9)]
        
        # Calculate cell dimensions
        cell_h = h // 9
        cell_w = w // 9
        
        # Extract each cell
        for row in range(9):
            for col in range(9):
                # Calculate cell boundaries
                y1 = y + row * cell_h
                y2 = y + (row + 1) * cell_h
                x1 = x + col * cell_w
                x2 = x + (col + 1) * cell_w
                
                # Extract cell with some padding
                padding = 5
                cell = gray[y1+padding:y2-padding, x1+padding:x2-padding]
                
                # Use OCR to read the digit
                config = '--psm 10 --oem 3 -c tessedit_char_whitelist=123456789'
                text = pytesseract.image_to_string(cell, config=config).strip()
                
                # Convert to integer if valid digit found
                if text.isdigit() and 1 <= int(text) <= 9:
                    sudoku_grid[row][col] = int(text)
        
        return sudoku_grid

    def print_sudoku_grid(grid):
        """Print the Sudoku grid in a readable format."""
        for i, row in enumerate(grid):
            if i % 3 == 0 and i != 0:
                print("-" * 21)
            row_str = ""
            for j, num in enumerate(row):
                if j % 3 == 0 and j != 0:
                    row_str += "| "
                row_str += str(num if num != 0 else ".") + " "
            print(row_str)